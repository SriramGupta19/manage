<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Manager Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <style>
        :root {
            --bg: #F9FAFB;
            --text: #1F2937;
            --header-bg: white;
            --card-bg: white;
            --modal-bg: white;
            --input-bg: white;
            --border-color: #E5E7EB;
            
            /* Priority Theme Colors (Light Mode) */
            --bg-high: #FEF2F2; --border-high: #FECACA; --text-high: #991B1B;
            --bg-med:  #FFFBEB; --border-med:  #FDE68A; --text-med:  #92400E;
            --bg-low:  #EFF6FF; --border-low:  #BFDBFE; --text-low:  #1E40AF;

            --header-height: 60px;
        }

        /* --- DARK MODE VARIABLES --- */
        body.dark-mode {
            --bg: #111827;
            --text: #F3F4F6;
            --header-bg: #1F2937;
            --card-bg: #1F2937;
            --modal-bg: #1F2937;
            --input-bg: #374151;
            --border-color: #374151;

            --bg-high: #450a0a; --border-high: #7f1d1d; --text-high: #fecaca;
            --bg-med:  #451a03; --border-med:  #78350f; --text-med:  #fde68a;
            --bg-low:  #172554; --border-low:  #1e3a8a; --text-low:  #bfdbfe;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- HEADER --- */
        header {
            height: var(--header-height);
            background: var(--header-bg); 
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; flex-shrink: 0; z-index: 50;
            transition: background 0.3s;
        }
        
        /* Flex containers for header items */
        .header-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-right { display: flex; align-items: center; gap: 10px; }

        h1 { font-family: 'Poppins', sans-serif; font-size: 1.1rem; margin: 0; font-weight: 600; white-space: nowrap;}
        
        /* Search Bar */
        .search-container { position: relative; max-width: 200px; width: 100%; }
        .search-input {
            width: 100%; padding: 6px 10px 6px 30px;
            border-radius: 20px; border: 1px solid var(--border-color);
            background: var(--bg); color: var(--text);
            font-size: 0.85rem; outline: none;
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #888; }

        .btn-header { background: var(--bg); border: 1px solid var(--border-color); color: var(--text); padding: 6px 10px; border-radius: 6px; font-weight: 500; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-header:hover { opacity: 0.8; }

        /* --- BOARD --- */
        .board {
            display: flex; flex: 1; gap: 4px; padding: 4px;
            height: calc(100vh - var(--header-height)); overflow: hidden;
        }

        .column {
            flex: 1; display: flex; flex-direction: column;
            border-radius: 8px; background: rgba(0,0,0,0.02); 
            overflow: hidden; min-width: 0;
        }

        .task-list { flex: 1; overflow-y: auto; padding: 4px; padding-bottom: 80px; }

        /* --- CARDS --- */
        .card {
            border-radius: 12px; padding: 12px; margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            min-height: 110px; position: relative; cursor: grab;
            border: 1px solid transparent; transition: transform 0.1s, background-color 0.3s;
        }
        .card:active { cursor: grabbing; transform: scale(0.98); }
        .card.completed { opacity: 0.6; filter: grayscale(0.6); }
        .card.completed .task-name { text-decoration: line-through; }

        .card-high { background-color: var(--bg-high); border-color: var(--border-high); color: var(--text-high); }
        .card-med  { background-color: var(--bg-med);  border-color: var(--border-med); color: var(--text-med); }
        .card-low  { background-color: var(--bg-low);  border-color: var(--border-low); color: var(--text-low); }

        .task-name { font-weight: 600; font-size: 0.95rem; line-height: 1.4; margin-bottom: 6px; word-wrap: break-word; }

        .info-row { font-size: 0.75rem; opacity: 0.8; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
        .tag-pill { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.1); font-weight: 600; }

        .progress-bar-bg { height: 4px; width: 100%; background: rgba(0,0,0,0.1); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: currentColor; width: 0%; transition: width 0.3s; opacity: 0.7; }
        .subtask-text { font-size: 0.7rem; margin-top: 2px; opacity: 0.8; text-align: right; }

        .card-footer { margin-top: auto; display: flex; justify-content: flex-end; padding-top: 10px; }

        .btn-group { display: flex; gap: 8px; }
        .circle-btn {
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1);
            background: var(--card-bg); display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-del { color: #DC2626; }
        .btn-chk { color: #059669; }

        /* --- MOBILE OPTIMIZATION (CSS MAGIC HERE) --- */
        @media (max-width: 600px) {
            /* 1. Header: Un-crammed */
            header {
                height: auto; /* Allow growth */
                flex-wrap: wrap;
                padding: 10px;
                gap: 10px;
            }
            .header-left {
                width: 100%;
                order: 2; /* Move search below buttons */
                margin-top: 0px;
            }
            .header-right {
                width: 100%;
                order: 1; /* Greeting and buttons on top */
                justify-content: space-between; /* Spread them out */
            }
            /* Move greeting into the right flex container visually */
            #greeting { order: -1; margin-right: auto; } /* Push buttons to right */
            .search-container { max-width: 100%; width: 100%; }
            
            /* Board Adjustment: Reduce gaps */
            .board { padding: 2px; gap: 2px; height: calc(100vh - 100px); /* Adjust for taller header */ }
            
            /* 2. Card Layout: Vertical Stacking */
            .card {
                padding: 8px 4px; /* Save space */
                min-height: auto;
            }
            .task-name {
                font-size: 0.8rem; /* Reduced font */
                text-align: center;
                margin-bottom: 4px;
            }
            
            /* Stack Info Rows (Date, Status) Vertically */
            .info-row {
                flex-direction: column;
                justify-content: center;
                text-align: center;
                font-size: 0.7rem;
                gap: 2px;
            }
            
            /* Center Tags */
            .tags-container { justify-content: center; margin-bottom: 4px; }
            .tag-pill { font-size: 0.6rem; padding: 1px 4px; }

            /* 3. Center Buttons */
            .card-footer {
                justify-content: center; /* Center buttons */
                padding-top: 6px;
            }
            .circle-btn { width: 24px; height: 24px; font-size: 12px; } /* Smaller buttons */
            
            .progress-bar-bg { width: 80%; margin: 4px auto; }
            .subtask-text { text-align: center; font-size: 0.65rem; }
        }


        /* --- MODAL --- */
        #login-screen { position: fixed; top:0; left:0; right:0; bottom:0; background: #4F46E5; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:100; }
        .google-btn { background:white; color:#333; padding:12px 20px; border-radius:50px; border:none; font-weight:600; cursor:pointer; }
        
        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: #111; color: white; border-radius: 50%; font-size: 28px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 90; }
        body.dark-mode .fab { background: #4F46E5; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; }
        .modal-content { background:var(--modal-bg); color: var(--text); width:90%; max-width:350px; padding:20px; border-radius:16px; max-height: 90vh; overflow-y: auto; }
        
        label { font-size: 0.75rem; font-weight: 600; opacity: 0.7; display: block; margin-bottom: 4px; margin-top: 10px; }
        input, select { width: 100%; padding: 10px; margin-bottom: 2px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--input-bg); color: var(--text); }
        
        .subtask-input-group { display: flex; gap: 5px; margin-bottom: 5px; }
        .subtask-check { width: auto !important; margin: 0 !important; }

        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-save { background: #111; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;}
        body.dark-mode .btn-save { background: #4F46E5; }

        #archive-screen { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 80; padding: 20px; flex-direction: column; }
        #archive-list { flex: 1; overflow-y: auto; margin-top: 10px; }
        .archive-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="font-size:2rem; margin-bottom:10px">Task Manager</h1>
        <button class="google-btn" onclick="signIn()">Sign in with Google</button>
    </div>

    <div id="app" style="display:none">
        <header>
            <div class="header-left">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search..." onkeyup="filterTasks()">
                </div>
            </div>
            
            <div class="header-right">
                <h1 id="greeting" style="margin-right:15px">Hi</h1>

                <button class="btn-header" onclick="toggleArchiveView()" title="View Archive">üìÇ</button>
                <button class="btn-header" onclick="toggleDarkMode()" id="themeBtn">üåô</button>
                <button class="btn-header" onclick="logout()">üèÉ</button>
            </div>
        </header>

        <div class="board">
            <div class="column" id="col-high"><div id="list-high" class="task-list"></div></div>
            <div class="column" id="col-med"><div id="list-med" class="task-list"></div></div>
            <div class="column" id="col-low"><div id="list-low" class="task-list"></div></div>
        </div>

        <button class="fab" onclick="openModal()">+</button>
    </div>

    <div id="archive-screen">
        <div class="archive-header">
            <h2>Archived Tasks</h2>
            <button class="btn-header" onclick="toggleArchiveView()">Close</button>
        </div>
        <p style="font-size:0.8rem; opacity:0.6">Completed tasks moved here to clean up your board.</p>
        <div id="archive-list"></div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Task Details</h2>
            <input type="hidden" id="taskId">
            
            <label>Task Name</label>
            <input type="text" id="taskName">

            <label>Tags (comma separated)</label>
            <input type="text" id="taskTags" placeholder="e.g. Research, Personal">

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Due Date</label>
                    <input type="date" id="taskDate">
                </div>
                <div style="flex:1">
                    <label>Priority</label>
                    <select id="taskPriority">
                        <option value="high">High (Red)</option>
                        <option value="med">Medium (Yellow)</option>
                        <option value="low">Low (Blue)</option>
                    </select>
                </div>
            </div>

            <label>Status</label>
            <select id="taskStatus">
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Waiting">Waiting</option>
                <option value="Almost Done">Almost Done</option>
            </select>

            <label>Subtasks</label>
            <div id="subtaskList"></div>
            <button onclick="addSubtaskInput()" style="margin-top:5px; background:none; border:1px dashed #aaa; width:100%; padding:5px; cursor:pointer; color:var(--text)">+ Add Subtask</button>
            
            <div class="modal-btns">
                <button class="btn-header" style="border:none; background:none; color:red" onclick="archiveCurrentTask()">Archive</button>
                <div style="flex:1"></div>
                <button onclick="closeModal()" style="background:none; border:none; color:var(--text); cursor:pointer">Cancel</button>
                <button class="btn-save" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCT8IUeGW2OAslHjS8MfeXrZjbXAmpAcuM",
          authDomain: "manager-651e5.firebaseapp.com",
          projectId: "manager-651e5",
          storageBucket: "manager-651e5.firebasestorage.app",
          messagingSenderId: "664846676694",
          appId: "1:664846676694:web:119e02bf56a8d5b9db4f77"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(()=>{});

        let currentUser = null, unsubscribe = null;
        let allTasks = [];

        if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
        function toggleDarkMode(){
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('themeBtn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        auth.onAuthStateChanged(u => {
            if(u){ 
                currentUser=u; 
                document.getElementById('login-screen').style.display='none'; 
                document.getElementById('app').style.display='block'; 
                document.getElementById('greeting').innerText = u.displayName ? u.displayName.split(' ')[0] : 'User'; 
                loadTasks(); 
                initDrag(); 
            } else { 
                currentUser=null; 
                document.getElementById('login-screen').style.display='flex'; 
                document.getElementById('app').style.display='none'; 
            }
        });

        function signIn(){ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout(){ auth.signOut(); }

        function initDrag(){
            ['list-high','list-med','list-low'].forEach(id=>{
                new Sortable(document.getElementById(id), { group:'shared', animation:150, delay:100, delayOnTouchOnly:true,
                    onEnd: (evt) => {
                        const pid = evt.to.id.split('-')[1];
                        if(pid) db.collection('tasks').doc(evt.item.dataset.id).update({priority:pid});
                    }
                });
            });
        }

        function loadTasks(){
            if(unsubscribe) unsubscribe();
            unsubscribe = db.collection('tasks').where('uid','==',currentUser.uid).onSnapshot(snap => {
                allTasks = [];
                snap.forEach(d=>allTasks.push({id:d.id, ...d.data()}));
                allTasks.sort((a,b)=>(a.completed===b.completed)?(new Date(a.dueDate||'9999')-new Date(b.dueDate||'9999')):(a.completed?1:-1));
                renderAll();
            });
        }

        function renderAll() {
            ['high','med','low'].forEach(p=>document.getElementById('list-'+p).innerHTML='');
            document.getElementById('archive-list').innerHTML='';

            const term = document.getElementById('searchInput').value.toLowerCase();

            allTasks.forEach(t => {
                const match = t.name.toLowerCase().includes(term) || (t.tags && t.tags.join(' ').toLowerCase().includes(term));
                if(!match) return;
                if (t.archived) renderArchiveTask(t);
                else renderTask(t);
            });
        }

        function filterTasks() { renderAll(); }

        function renderTask(t){
            const d = document.createElement('div');
            d.className = `card card-${t.priority} ${t.completed?'completed':''}`;
            d.dataset.id = t.id;
            d.onclick = (e) => { if(!e.target.closest('button') && !e.target.closest('input')) openModal(t); };

            const dateStr = t.dueDate ? new Date(t.dueDate).toLocaleDateString('en-US', {month:'short', day:'numeric'}) : '';
            
            let tagsHtml = '';
            if(t.tags && t.tags.length > 0) {
                tagsHtml = '<div class="tags-container">' + t.tags.map(tag => `<span class="tag-pill">${tag}</span>`).join('') + '</div>';
            }

            let progressHtml = '';
            if(t.subtasks && t.subtasks.length > 0) {
                const done = t.subtasks.filter(s=>s.done).length;
                const total = t.subtasks.length;
                const pct = (done/total)*100;
                progressHtml = `
                    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
                    <div class="subtask-text">${done}/${total} subtasks</div>
                `;
            }

            // Note: info-row is flex-column on mobile via CSS
            d.innerHTML = `
                ${tagsHtml}
                <div class="task-name">${t.name}</div>
                
                <div class="info-row">
                    ${dateStr ? `<span>üìÖ ${dateStr}</span>` : ''} 
                    <span>üìå ${t.status || 'Not Started'}</span>
                </div>
                
                ${progressHtml}

                <div class="card-footer">
                    <div class="btn-group">
                        <button class="circle-btn btn-del" onclick="delTask('${t.id}')">‚úï</button>
                        <button class="circle-btn btn-chk" onclick="toggle('${t.id}',${!t.completed})">‚úì</button>
                    </div>
                </div>
            `;
            document.getElementById('list-'+t.priority).appendChild(d);
        }

        function renderArchiveTask(t) {
            const d = document.createElement('div');
            d.className = `card card-${t.priority}`;
            d.style.opacity = "0.7";
            d.innerHTML = `<div class="task-name">${t.name}</div><div class="info-row">Archived</div>
            <div class="card-footer"><button class="btn-header" onclick="unarchive('${t.id}')">Restore</button></div>`;
            document.getElementById('archive-list').appendChild(d);
        }

        function addSubtaskInput(text='', done=false) {
            const div = document.createElement('div');
            div.className = 'subtask-input-group';
            div.innerHTML = `
                <input type="checkbox" class="subtask-check" ${done?'checked':''}>
                <input type="text" class="subtask-val" value="${text}" placeholder="Subtask...">
                <button onclick="this.parentElement.remove()" style="color:red;border:none;background:none;cursor:pointer">√ó</button>
            `;
            document.getElementById('subtaskList').appendChild(div);
        }

        function saveTask(){
            const id=document.getElementById('taskId').value;
            const n=document.getElementById('taskName').value;
            if(!n) return;

            const tagStr = document.getElementById('taskTags').value;
            const tags = tagStr ? tagStr.split(',').map(s=>s.trim()).filter(s=>s) : [];

            const subEls = document.querySelectorAll('.subtask-input-group');
            const subtasks = [];
            subEls.forEach(el => {
                const val = el.querySelector('.subtask-val').value;
                if(val) subtasks.push({ text: val, done: el.querySelector('.subtask-check').checked });
            });

            const data = { 
                uid: currentUser.uid, 
                name: n, 
                dueDate: document.getElementById('taskDate').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                tags: tags,
                subtasks: subtasks,
                archived: false
            };

            if(id) db.collection('tasks').doc(id).update(data);
            else { 
                data.completed = false; 
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); 
                db.collection('tasks').add(data); 
            }
            closeModal();
        }

        function delTask(id){ if(confirm('Delete permanently?')) db.collection('tasks').doc(id).delete(); }
        function toggle(id,s){ db.collection('tasks').doc(id).update({completed:s}); }
        function archiveCurrentTask() {
            const id = document.getElementById('taskId').value;
            if(id) { db.collection('tasks').doc(id).update({archived:true}); closeModal(); }
        }
        function unarchive(id) { db.collection('tasks').doc(id).update({archived:false}); }
        function toggleArchiveView() {
            const el = document.getElementById('archive-screen');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        function openModal(t=null){
            document.getElementById('taskId').value=t?t.id:'';
            document.getElementById('taskName').value=t?t.name:'';
            document.getElementById('taskDate').value=t?t.dueDate:'';
            document.getElementById('taskPriority').value=t?t.priority:'high';
            document.getElementById('taskStatus').value=t?t.status:'Not Started';
            document.getElementById('taskTags').value=t && t.tags ? t.tags.join(', ') : '';
            
            const sl = document.getElementById('subtaskList');
            sl.innerHTML = '';
            if(t && t.subtasks) t.subtasks.forEach(s => addSubtaskInput(s.text, s.done));
            else if(!t) addSubtaskInput();

            document.getElementById('taskModal').style.display='flex';
            if(!t) setTimeout(()=>document.getElementById('taskName').focus(),100);
        }
        function closeModal(){ document.getElementById('taskModal').style.display='none'; }
        window.onclick=(e)=>{if(e.target.id=='taskModal')closeModal();}
    </script>
</body>
</html>
